# 耕食记 (CuisineFarming) 操作文档

## 1. 系统概述 (Overview)
**耕食记** 是一个深度整合农业种植与烹饪制作的沉浸式经营插件。目前阶段核心实现了 **动态肥力系统**，将原本简单的“播种-收割”循环转化为需要维护土地肥力、合理施肥的策略性玩法。

系统通过 **PDC (PersistentDataContainer)** 技术将肥力数据直接绑定在区块上，实现了高性能的数据存储与动态恢复逻辑。

---

## 2. 核心架构 (Core Architecture)

| 模块 | 类文件 | 职责 |
| :--- | :--- | :--- |
| **插件核心** | `CuisineFarming.java` | 插件入口，负责管理器初始化、命令注册与任务调度。 |
| **肥力核心** | `FertilityManager.java` | **[核心]** 负责肥力的计算、存储与动态恢复算法。实现了基于时间的异步恢复逻辑。 |
| **区块数据** | `ChunkFertilityData.java` | 定义区块肥力数据的结构（基础肥力、肥料类型、上次更新时间等）。 |
| **种植监听** | `FarmingListener.java` | 监听作物生长 (`BlockGrowEvent`)，根据肥力值干预生长速度（加速/减速/跳级）。 |
| **视觉辅助** | `MonocleTask.java` | 负责“农夫单片镜”的射线检测与 ActionBar 数值显示。 |
| **物品管理** | `CuisineItemManager.java` | 管理自定义农具与肥料（如有机肥、化肥、单片镜）。 |
| **指令系统** | `CuisineCommandExecutor.java` | 处理 `/getorganic`, `/getmonocle` 等管理员指令。 |

---

## 3. 详细模块解析 (Detailed Module Analysis)

### 3.1 土地肥力系统 (`FertilityManager.java`)
该系统模拟了真实的土壤养分循环，由 **基础肥力 (Base Fertility)** 和 **肥料浓度 (Concentration)** 双轨驱动。

*   **基础肥力**: 
    *   范围: `-100` (极度贫瘠) ~ `100` (满肥) ~ `150` (超肥/有肥料加成)。
    *   **熵增消耗**: 肥力越高，作物吸收越快。消耗公式: `Cost = BaseCost * (1.0 + Fertility / 200.0)`。这意味着维持高肥力需要更多的投入。

*   **肥料浓度 (Concentration)**:
    *   这是土壤中当前活性养分的指标。
    *   **自然衰减**: 无论是否有作物，浓度都会以 **1.0/分钟** 的速度自然衰减 (在湿润耕地上)。
    *   **双刃剑机制**:
        *   **安全区 (0 - 100)**: 浓度越高，肥力恢复速度越快 (`K` 值提升)，且允许肥力上限突破至 `150`。
        *   **过量区 (100 - 200)**: 开始出现副作用，恢复速度提升收益递减。
        *   **剧毒区 (> 200)**: 烧苗效应。恢复速度大幅下降甚至变为负值（倒扣肥力），模拟施肥过量烧死作物。

### 3.2 生长干预系统 (核心机制)
插件彻底重构了原版的作物生长逻辑，实现了**动态 g 值计算**与**统一效率公式**，成为三大系统的核心枢纽。

#### 3.2.1 统一效率公式 (`Efficiency`)
所有外部系统（BiomeGifts, EarthSpirit）的加成最终都汇总于此，计算出唯一的生长效率倍率：
> **Efficiency = 1.0 + Δ(Fertility) + Δ(Biome) + Δ(Spirit)**

*   **基准值**: 1.0
*   **Δ(Fertility)**: 肥力修正。`EffectiveFertility * 0.005`。
    *   范围: -0.5 (贫瘠) ~ +0.5 (满肥)
*   **Δ(Biome)**: 群系修正 (来自 **BiomeGifts**)。
    *   Rich: +0.3 (或其他配置值)
    *   Poor: -0.3 (或其他配置值)
*   **Δ(Spirit)**: 地灵修正 (来自 **EarthSpirit**)。
    *   范围: 0.0 ~ +1.0 (取决于地灵心情与等级)

#### 3.2.2 双向生长控制
根据最终计算出的 `Efficiency`，系统采取截然不同的处理策略：

1.  **减速/拦截 (`FarmingListener`)**:
    *   当 `Efficiency < 1.0` 时触发。
    *   计算失败概率 `P_fail = 1.0 - Efficiency`。
    *   若判定失败，**取消**原版生长事件 (`event.setCancelled(true)`)。
    *   *效果：作物生长变得极慢，模拟土地贫瘠或恶劣环境。*

2.  **主动生长系统 (`Active Growth System`)**:
    *   **核心机制**: 插件彻底抛弃了依赖原版 RandomTick 触发的被动加速模式，转而使用**主动式概率运算**。
    *   **智能注册表 (`Crop Registry`)**: 系统会自动追踪所有位于高肥力土地上的作物，将其纳入“加速名单”。
    *   **独立频率运算**: 
        *   不仅是增加单次生长的*幅度*，而是直接增加生长的*频率*。
        *   插件每 tick 都会对注册表中的作物进行独立判定，根据 `Efficiency` 计算额外的生长概率。
        *   **公式**: `P_extra = (Efficiency - 1.0) * P_vanilla`
    *   **优势**: 
        *   **极致丝滑**: 作物会在原版随机刻的间隙中自然生长，真正实现了“生长速度翻倍 = 生长频率翻倍”的视觉效果。
        *   **性能优异**: 得益于注册表机制，系统无需扫描全图，仅对有效作物进行 O(1) 级别的快速运算，即使万亩良田也能流畅运行。
        *   **抗压能力**: 完美支持 10000+ TickSpeed 的压力测试，概率算法在数学期望上与原版严格对齐。

#### 3.2.3 动态 g 值计算 (Vanilla-Aligned)
为了保证加速逻辑的科学性，插件完美复刻并动态计算了 Minecraft 原版作物生长积分 `g` (points)：
*   **公式**: `g = (1.0 + MoistureBonus + FarmlandBonus) / (Penalty + 1)`
    *   检测周围 8 格耕地是否湿润。
    *   检测同种作物是否相邻（同种惩罚）。
    *   检测对角线作物分布。
*   **概率转化**: `p = 1 / (floor(25 / g) + 1)`
*   *意义：这确保了我们的加速并非无脑 +1，而是严格遵循原版种植布局策略（如隔行种植最优解）。*

#### 3.2.4 骨粉机制 (Bone Meal Handling)
为了防止玩家利用原版骨粉机制绕过肥力消耗，系统对人工催熟进行了特殊处理：
*   **免除肥力消耗**: 
    *   玩家使用骨粉催熟作物时，**不消耗**任何土地肥力。
    *   收割带有“人工催熟”标记的作物时，也**不消耗**肥力。
    *   *目的：允许玩家低成本快速获取普通农作物（如刷小麦合成面包）。*
*   **特产掉落屏蔽**:
    *   凡是经过骨粉催熟（哪怕只是一次）的作物，收割时**绝对不会掉落**特产（如黄金麦穗）。
    *   *目的：稀有特产必须通过消耗肥力自然生长获得，确保经济平衡。*

### 3.3 农夫单片镜 (`MonocleTask.java`)
*   **物品**: `FARMER_MONOCLE` (基于铁头盔的自定义物品)。
*   **用法**: 装备在 **头盔槽** 位。
*   **效果**: 当准星对准耕地（距离10格内）时，ActionBar 实时显示 **土地肥力** 与 **肥料浓度** 双重数值。
*   **特性**: 支持 **视线穿透**，即使耕地上方有成熟作物，也能直接读取下方土壤数据。
*   **视觉反馈**:
    *   **土地肥力 (Left)**:
        *   **§6金色**: > 100 (溢出/极佳)
        *   **§a绿色**: 50 - 100 (良好)
        *   **§e黄色**: 0 - 50 (一般)
        *   **§c红色**: < 0 (贫瘠)
    *   **肥料浓度 (Right)**:
        *   **§4深红 (剧毒)**: > 200 (严重烧苗警告)
        *   **§c红色 (过量)**: > 100 (收益递减警告)
        *   **§e黄色 (活性)**: > 0 (正常生效中)
        *   **§7灰色 (无)**: 0 (需施肥)

### 3.4 肥料系统
目前实现了两种基础肥料，它们通过增加 **肥料浓度** 来生效：

1.  **有机肥料 (Organic Fertilizer)**: 
    *   **效果**: 浓度 **+20.0**。
    *   **特点**: 温和安全，适合日常维护。即便连用多次也不易突破安全阈值。
2.  **高效化肥 (Chemical Fertilizer)**: 
    *   **效果**: 浓度 **+50.0**。
    *   **特点**: 效果强劲，能迅速拉升肥力恢复速度。但需严格控制用量，连用 3 次即进入过量区，4 次即可能触发剧毒烧苗。

**交互优化**: 支持 **穿透施肥**。玩家可以直接对着作物右键使用肥料，系统会自动判定并作用于下方的耕地，无需先收割作物。

### 3.5 调试工具 (`DebugListener.java`)
*   **工具**: `STICK` (木棍)
*   **用法**: 手持木棍 **右键点击** 耕地或作物。
*   **定位**: 开发者与管理员专用的诊断工具，用于验证“统一效率公式”在各子系统间的执行准确性。
*   **显示面板**:
    1.  **核心计算**:
        *   显示系统最终采用的 **统一效率值 (Total Efficiency)**。
        *   显示反推出的 **基础肥力修正**，确保数据源头一致。
    2.  **环境参数 (Vanilla Mechanics)**:
        *   **g 值 (Points)**: 严格遵循原版算法的生长点数（受周围耕地、作物布局影响）。
        *   **p 值 (Probability)**: 当前 tick 下该作物的原版生长概率。
        *   *作用: 用于排查为何“肥力很高但长得慢”（通常是 g 值太低，如密植惩罚）。*
    3.  **子系统详情**:
        *   **基础肥力**: 显示当前肥力值、浓度值及对应的修正百分比。
        *   **地域环境 (Biome)**: 显示当前群系及 BiomeGifts 插件判定的富集/贫瘠状态。
        *   **地灵共鸣 (Spirit)**: 显示 EarthSpirit 地灵的激活状态、心情值与提供的额外加成。
    4.  **综合预估**:
        *   汇总所有加成，给出最终的 **生长效率总计 (Total Growth %)**。
        *   例如: `+80%` 意味着生长速度是原版的 1.8 倍。
    5.  **特产掉落预估**:
        *   显示当前的特产掉落总概率及构成（基础 + 肥力 + 地灵）。
        *   *注：CuisineFarming 不再直接处理掉落，而是提供数据供 BiomeGifts 统一计算。*

---

## 4. 指令与权限 (Commands & Permissions)

| 指令 | 权限 | 描述 |
| :--- | :--- | :--- |
| `/getmonocle` | `cuisinefarming.get` | 获取农夫单片镜（查看肥力用）。 |
| `/getorganic` | `cuisinefarming.get` | 获取有机肥料。 |
| `/getchemical` | `cuisinefarming.get` | 获取高效化肥。 |

---

## 5. 开发进度与计划 (Development Status)

### 已实现 (Implemented)
- [x] 基于 PDC 的区块肥力数据存储。
- [x] 湿润耕地的动态肥力恢复算法。
- [x] 基于肥力的作物生长干预（加速/减速）。
- [x] 农夫单片镜视觉反馈。
- [x] 基础肥料物品与施肥逻辑。

### 待实现 (Pending)
- [ ] **视觉层**: 耕地材质随肥力动态变化 (ItemsAdder/Oraxen)。
- [ ] **基因系统**: 种子鉴定、杂交与优选。
- [ ] **温室系统**: 温度计算与微气候模拟。
- [ ] **烹饪系统**: 厨具交互与 QTE 烹饪。

---

**文档维护人**: 开发组
**最后更新**: 2025-12-20
