# 耕食记 (CuisineFarming) 操作文档

## 1. 系统概述 (Overview)
**耕食记** 是一个深度整合农业种植与烹饪制作的沉浸式经营插件。目前阶段核心实现了 **动态肥力系统**，将原本简单的“播种-收割”循环转化为需要维护土地肥力、合理施肥的策略性玩法。

系统通过 **PDC (PersistentDataContainer)** 技术将肥力数据直接绑定在区块上，实现了高性能的数据存储与动态恢复逻辑。

---

## 2. 核心架构 (Core Architecture)

| 模块 | 类文件 | 职责 |
| :--- | :--- | :--- |
| **插件核心** | `CuisineFarming.java` | 插件入口，负责管理器初始化、命令注册与任务调度。 |
| **肥力核心** | `FertilityManager.java` | **[核心]** 负责肥力的计算、存储与动态恢复算法。实现了基于时间的异步恢复逻辑。 |
| **区块数据** | `ChunkFertilityData.java` | 定义区块肥力数据的结构（基础肥力、肥料类型、上次更新时间等）。 |
| **种植监听** | `FarmingListener.java` | 监听作物生长 (`BlockGrowEvent`)，根据肥力值干预生长速度（加速/减速/跳级）。 |
| **视觉辅助** | `MonocleTask.java` | 负责“农夫单片镜”的射线检测与 ActionBar 数值显示。 |
| **物品管理** | `CuisineItemManager.java` | 管理自定义农具与肥料（如有机肥、化肥、单片镜）。 |
| **指令系统** | `CuisineCommandExecutor.java` | 处理 `/getorganic`, `/getmonocle` 等管理员指令。 |

---

## 3. 详细模块解析 (Detailed Module Analysis)

### 3.1 土地肥力系统 (`FertilityManager.java`)
该系统模拟了真实的土壤养分循环，由 **基础肥力 (Base Fertility)** 和 **肥料浓度 (Concentration)** 双轨驱动。

*   **基础肥力**: 
    *   范围: `-100` (极度贫瘠) ~ `100` (满肥) ~ `150` (超肥/有肥料加成)。
    *   **熵增消耗**: 肥力越高，作物吸收越快。消耗公式: `Cost = BaseCost * (1.0 + Fertility / 200.0)`。这意味着维持高肥力需要更多的投入。

*   **肥料浓度 (Concentration)**:
    *   这是土壤中当前活性养分的指标。
    *   **自然衰减**: 无论是否有作物，浓度都会以 **1.0/分钟** 的速度自然衰减 (在湿润耕地上)。
    *   **双刃剑机制**:
        *   **安全区 (0 - 100)**: 浓度越高，肥力恢复速度越快 (`K` 值提升)，且允许肥力上限突破至 `150`。
        *   **过量区 (100 - 200)**: 开始出现副作用，恢复速度提升收益递减。
        *   **剧毒区 (> 200)**: 烧苗效应。恢复速度大幅下降甚至变为负值（倒扣肥力），模拟施肥过量烧死作物。

### 3.2 生长干预系统 (核心机制)
插件彻底重构了原版的作物生长逻辑，实现了**动态 g 值计算**与**统一效率公式**，成为三大系统的核心枢纽。

#### 3.2.1 统一效率公式 (`Efficiency`)
所有外部系统（基因、BiomeGifts, EarthSpirit）的加成最终都汇总于此，计算出唯一的生长效率倍率：
> **Efficiency = 1.0 + Δ(Fertility) + Δ(Genes) + Δ(Biome) + Δ(Spirit)**

*   **基准值**: 1.0
*   **Δ(Fertility)**: 肥力修正。
    *   **普通作物**: `EffectiveFertility * 0.005` (范围 -0.5 ~ +0.5)。
    *   **基因作物**: **被耐肥性基因 (Resistance) 接管**。
        *   公式: `0.01 * Concentration * (1 - Concentration / (2 * Resistance))`
        *   范围: 取决于耐受值与浓度的匹配度，最高可达 `0.005 * Resistance`。
*   **Δ(Genes)**: 基因修正。
    *   主要由 **生长速度 (Growth Speed)** 基因提供。
    *   范围: `-0.5` (1星) ~ `+1.0` (5星)。
*   **Δ(Biome)**: 群系修正 (来自 **BiomeGifts**)。
    *   Rich: +0.3 (或其他配置值)
    *   Poor: -0.3 (或其他配置值)
*   **Δ(Spirit)**: 地灵修正 (来自 **EarthSpirit**)。
    *   范围: 0.0 ~ +1.0 (取决于地灵心情与等级)

#### 3.2.2 双向生长控制
根据最终计算出的 `Efficiency`，系统采取截然不同的处理策略：

1.  **减速/拦截 (`FarmingListener`)**:
    *   当 `Efficiency < 1.0` 时触发。
    *   计算失败概率 `P_fail = 1.0 - Efficiency`。
    *   若判定失败，**取消**原版生长事件 (`event.setCancelled(true)`)。
    *   *效果：作物生长变得极慢，模拟土地贫瘠或恶劣环境。*

2.  **主动生长系统 (`Active Growth System`)**:
    *   **核心机制**: 插件彻底抛弃了依赖原版 RandomTick 触发的被动加速模式，转而使用**主动式概率运算**。
    *   **智能注册表 (`Crop Registry`)**: 系统会自动追踪所有位于高肥力土地上的作物，将其纳入“加速名单”。
    *   **独立频率运算**: 
        *   不仅是增加单次生长的*幅度*，而是直接增加生长的*频率*。
        *   插件每 tick 都会对注册表中的作物进行独立判定，根据 `Efficiency` 计算额外的生长概率。
        *   **公式**: `P_extra = (Efficiency - 1.0) * P_vanilla`
    *   **优势**: 
        *   **极致丝滑**: 作物会在原版随机刻的间隙中自然生长，真正实现了“生长速度翻倍 = 生长频率翻倍”的视觉效果。
        *   **性能优异**: 得益于注册表机制，系统无需扫描全图，仅对有效作物进行 O(1) 级别的快速运算，即使万亩良田也能流畅运行。
        *   **抗压能力**: 完美支持 10000+ TickSpeed 的压力测试，概率算法在数学期望上与原版严格对齐。

#### 3.2.3 动态 g 值计算 (Vanilla-Aligned)
为了保证加速逻辑的科学性，插件完美复刻并动态计算了 Minecraft 原版作物生长积分 `g` (points)：
*   **公式**: `g = (1.0 + MoistureBonus + FarmlandBonus) / (Penalty + 1)`
    *   检测周围 8 格耕地是否湿润。
    *   检测同种作物是否相邻（同种惩罚）。
    *   检测对角线作物分布。
*   **概率转化**: `p = 1 / (floor(25 / g) + 1)`
*   *意义：这确保了我们的加速并非无脑 +1，而是严格遵循原版种植布局策略（如隔行种植最优解）。*

#### 3.2.4 骨粉机制 (Bone Meal Handling)
为了防止玩家利用原版骨粉机制绕过肥力消耗，系统对人工催熟进行了特殊处理：
*   **免除肥力消耗**: 
    *   玩家使用骨粉催熟作物时，**不消耗**任何土地肥力。
    *   收割带有“人工催熟”标记的作物时，也**不消耗**肥力。
    *   *目的：允许玩家低成本快速获取普通农作物（如刷小麦合成面包）。*
*   **特产掉落屏蔽**:
    *   凡是经过骨粉催熟（哪怕只是一次）的作物，收割时**绝对不会掉落**特产（如黄金麦穗）。
    *   *目的：稀有特产必须通过消耗肥力自然生长获得，确保经济平衡。*

### 3.3 农夫单片镜 (`MonocleTask.java`)
*   **物品**: `FARMER_MONOCLE` (基于铁头盔的自定义物品)。
*   **用法**: 装备在 **头盔槽** 位。
*   **效果**: 当准星对准耕地（距离10格内）时，ActionBar 实时显示 **土地肥力** 与 **肥料浓度** 双重数值。
*   **特性**: 支持 **视线穿透**，即使耕地上方有成熟作物，也能直接读取下方土壤数据。
*   **视觉反馈**:
    *   **土地肥力 (Left)**:
        *   **§6金色**: > 100 (溢出/极佳)
        *   **§a绿色**: 50 - 100 (良好)
        *   **§e黄色**: 0 - 50 (一般)
        *   **§c红色**: < 0 (贫瘠)
    *   **肥料浓度 (Right)**:
        *   **§4深红 (剧毒)**: > 200 (严重烧苗警告)
        *   **§c红色 (过量)**: > 100 (收益递减警告)
        *   **§e黄色 (活性)**: > 0 (正常生效中)
        *   **§7灰色 (无)**: 0 (需施肥)

### 3.4 肥料系统
目前实现了两种基础肥料，它们通过增加 **肥料浓度** 来生效：

1.  **有机肥料 (Organic Fertilizer)**: 
    *   **效果**: 浓度 **+20.0**。
    *   **特点**: 温和安全，适合日常维护。即便连用多次也不易突破安全阈值。
2.  **高效化肥 (Chemical Fertilizer)**: 
    *   **效果**: 浓度 **+50.0**。
    *   **特点**: 效果强劲，能迅速拉升肥力恢复速度。但需严格控制用量，连用 3 次即进入过量区，4 次即可能触发剧毒烧苗。

**交互优化**: 支持 **穿透施肥**。玩家可以直接对着作物右键使用肥料，系统会自动判定并作用于下方的耕地，无需先收割作物。

### 3.5 调试工具 (`DebugListener.java`)
*   **工具**: `STICK` (木棍)
*   **用法**: 手持木棍 **右键点击** 耕地或作物。
*   **定位**: 开发者与管理员专用的诊断工具，用于验证“统一效率公式”在各子系统间的执行准确性。
*   **显示面板**:
    1.  **核心计算**:
        *   显示系统最终采用的 **统一效率值 (Total Efficiency)**。
        *   显示反推出的 **基础肥力修正**，确保数据源头一致。
    2.  **环境参数 (Vanilla Mechanics)**:
        *   **g 值 (Points)**: 严格遵循原版算法的生长点数（受周围耕地、作物布局影响）。
        *   **p 值 (Probability)**: 当前 tick 下该作物的原版生长概率。
        *   *作用: 用于排查为何“肥力很高但长得慢”（通常是 g 值太低，如密植惩罚）。*
    3.  **子系统详情**:
        *   **基础肥力**: 显示当前肥力值、浓度值及对应的修正百分比。
        *   **地域环境 (Biome)**: 显示当前群系及 BiomeGifts 插件判定的富集/贫瘠状态。
        *   **地灵共鸣 (Spirit)**: 显示 EarthSpirit 地灵的激活状态、心情值与提供的额外加成。
    4.  **综合预估**:
        *   汇总所有加成，给出最终的 **生长效率总计 (Total Growth %)**。
        *   例如: `+80%` 意味着生长速度是原版的 1.8 倍。
    5.  **特产掉落预估**:
        *   显示当前的特产掉落总概率及构成（基础 + 肥力 + 地灵）。
        *   *注：CuisineFarming 不再直接处理掉落，而是提供数据供 BiomeGifts 统一计算。*

### 3.6 [融合架构] 统一基因系统 (Unified Genetics)
*(Status: Implemented - 已实装)*

本系统采用**“基因型驱动表型”**的架构，完美融合了“孟德尔遗传玩法”与“现有数值计算体系”。
*   **上游 (Genotype)**: 采用双等位基因存储数据，负责杂交、突变与遗传逻辑。
*   **下游 (Phenotype)**: 将基因型解析为具体数值（如生长速度倍率），供生长与肥力系统调用。

#### 3.6.1 基因型结构 (The Genotype)
每颗种子不再直接存储浮点数，而是存储一组**基因对 (Allele Pairs)**。
我们为作物定义了 6 大核心性状，每个性状对应一个特定的字母代号：

| 基因代号 | 性状名称 (Trait) | 对应旧版属性 | 描述 |
| :--- | :--- | :--- | :--- |
| **A** | **生长速度** (Growth Speed) | Growth Speed | 影响作物成熟快慢。 |
| **B** | **丰产能力** (Yield) | Yield | 影响收割时的额外掉落量。 |
| **C** | **温度适应** (Temperature) | Temp Tolerance | 决定对极端温度的耐受力。 |
| **D** | **土壤适应** (Soil Tolerance)| Fertility Resistance| 决定对高浓度肥料的耐受力（耐肥性）。 |
| **E** | **珍稀潜力** (Luck) | N/A | 影响伴生特产的发现率。 |
| **F** | **风味品质** (Quality) | N/A | 影响烹饪时的星级上限。 |

**等位基因 (Alleles)**:
*   基因分为显性（大写）与隐性（小写），数值代表强度。
*   **正向基因**: `A1`, `A2`, `A3` (强度递增，显示为绿色/金色)。
*   **负向基因**: `a1`, `a2`, `a3` (强度递增，显示为红色/深红)。
*   **默认基因**: 所有野生种子的默认基因为 **A1a1** (及对应其他字母)，代表一种微妙的平衡状态。

#### 3.6.2 表型解析规则 (Phenotype Mapping)
系统在运行时通过 `getGene(Trait)` 动态计算数值。特别引入了 **杂种优势 (Hybrid Vigor)** 机制：
*   **纯合子 (Homozygous)**: 如 `A3A3`，数值直接相加 (`3+3=6`)。
*   **杂合子 (Heterozygous)**: 如 `A3A2` (显性杂合)，数值相加后乘以 **2.0倍** (`(3+2)*2.0=10`)。
*   *设计意图：最高的数值并不来自最纯的基因（A3A3=6），而是来自最强的显性杂交组合（A3A2=10）。鼓励玩家收集不同种类的优质基因并进行杂交，而非单一维度的提纯。*
*   *(注：普通的杂交如 A3a1 得分为 (3-1)*2 = 4，虽然有加成但仍弱于 A3A3，因此玩家需追求“双强杂交”。)*

**1. 生长速度 (Trait A)**
*   **数值范围**: `-1.0` ~ `+1.0` (映射自基因总分，Max=10)。
*   **效果**: 直接作为 `Δ(Genes)` 加成到生长效率公式中。
*   *例*: `A3A2` (10分) -> `+1.0` 效率 (满速); `A3A3` (6分) -> `+0.6` 效率。

**2. 丰产能力 (Trait B)**
*   **机制**: **分段式额外掉落**。
*   **规则**: **1基因分 = 1判定区间**。
*   **概率**: 每个区间独立计算，均有 **25%** 的概率额外掉落一个原版作物。
*   *设计意图*: 鼓励追求高分，分数越高判定次数越多。
*   *例*: 
    *   总分 1 (A2A1) -> 1次判定 (25%) -> 期望获得0.25个额外作物。
    *   总分 4 (A2A2) -> 4次判定 (每次25%) -> 期望获得1个额外作物。
    *   总分 8 (A3A3) -> 8次判定 (每次25%) -> 期望获得2个额外作物，运气好可能更多。

**3. 土壤适应 (Trait D) - 耐肥性**
*   **对应旧版**: Fertility Resistance。
*   **公式**: `Bonus = 0.01 * Concentration * (1 - Concentration / (2 * Resistance))`
*   **效果**: 决定作物在高浓度肥料下的生存能力与吸收效率。
*   *高分基因 (A3A2)* 能提供高达 `400` 的 `Resistance`，允许作物在极高浓度的化肥地块上快速生长。

#### 3.6.3 种子状态与鉴定
*   **未鉴定 (Unidentified)**: 种子物品上无详细 Lore。
*   **已鉴定 (Identified)**: 
    *   **显示格式**: `性状名: [基因1, 基因2] (评价)`
    *   **示例**:
        *   `生长速度: [A1, a1] (普通的)` -> 默认状态
        *   `丰产能力: [B3, B3] (硕果的)` -> 极品纯合子
        *   `土壤适应: [d2, d2] (虚弱的)` -> 劣质纯合子

---

### 3.7 朴素生物学：种子鉴定与命名 (Rustic Genetics)
*(Status: Implemented - 已实装)*

#### 3.7.1 基因命名法 (Nomenclature)
种子在未进行详细鉴定（Seed Analyzer）之前，玩家只能通过其**外在表现**（即基因分数的绝对值）来模糊判断其特性。系统会自动根据种子最显著的性状为其命名。

*   **平平无奇的 (Ordinary)**:
    *   所有性状的基因分绝对值均 **< 3.0**。
    *   显示名称: `平平无奇的 [作物名]种子`。
    *   Lore: `(平平无奇)`。

*   **显著特征 (Significant Traits)**:
    *   任意性状的基因分绝对值 **>= 3.0**。
    *   **命名规则**: 取绝对值最大的性状对应的形容词作为前缀。
    *   **Lore 规则**: 以标签形式列出所有绝对值 >= 3.0 的性状。
    *   *例*: 一个同时具有 `生长速度: 6.0 (瞬息)` 和 `丰产能力: -4.0 (欠收)` 的种子。
        *   名称: `瞬息的 小麦种子` (取最大值 6.0)。
        *   Lore: `特征: §6[瞬息] §c[欠收]`。

#### 3.7.2 性状形容词表 (Adjective Table)
不同分数的基因表现对应不同的形容词，颜色代表强度。

**分级标准 (Tiers):**
*   **Tier 1 (3.0 - 4.9)**: 正向 `§a` (Green), 负向 `§c` (Red)
*   **Tier 2 (5.0 - 6.9)**: 正向 `§b` (Aqua), 负向 `§4` (Dark Red)
*   **Tier 3 (7.0 - 8.9)**: 正向 `§6` (Gold), 负向 `§5` (Dark Purple)
*   **Tier 4 (9.0+)**: 正向 `§d` (Light Purple), 负向 `§8` (Dark Gray)

**形容词对照:**

| 性状 (Trait) | 符号 | 正向 (+) (T1 / T2 / T3 / T4) | 负向 (-) (T1 / T2 / T3 / T4) |
| :--- | :---: | :--- | :--- |
| **生长速度** | A | **萌动** / **活力** / **躁动** / **疯长** | **慵懒** / **沉睡** / **僵硬** / **石化** |
| **丰产能力** | B | **饱满** / **沉重** / **满溢** / **炸裂** | **轻飘** / **干瘪** / **空心** / **尘埃** |
| **温度适应** | C | **厚皮** / **粗糙** / **绒毛** / **披甲** | **薄皮** / **娇嫩** / **剔透** / **气泡** |
| **土壤适应** | D | **壮实** / **黝黑** / **贪吃** / **暴食** | **瘦弱** / **苍白** / **敏感** / **焦黑** |
| **珍稀潜力** | E | **光洁** / **晶莹** / **金边** / **虹光** | **灰暗** / **斑驳** / **霉斑** / **漆黑** |
| **风味品质** | F | **清香** / **蜜渍** / **溢香** / **发光** | **生涩** / **发苦** / **腥臭** / **腐烂** |

#### 3.7.3 鉴定与分析
使用 **种子分析仪** 可查看完整基因图谱，包括具体的基因配对情况（如 `A1a1`）和详细数值评价。

---

## 4. 指令与权限 (Commands & Permissions)

| 指令 | 权限 | 描述 |
| :--- | :--- | :--- |
| `/getmonocle` | `cuisinefarming.get` | 获取农夫单片镜（查看肥力用）。 |
| `/getanalyzer` | `cuisinefarming.get` | 获取种子分析仪（鉴定种子用）。 |
| `/getorganic` | `cuisinefarming.get` | 获取有机肥料。 |
| `/getchemical` | `cuisinefarming.get` | 获取高效化肥。 |

---

## 5. 开发进度与计划 (Development Status)

### 已实现 (Implemented)
- [x] **数据层**: 基于 PDC 的区块肥力与基因数据存储。
- [x] **核心算法**: 湿润耕地的动态肥力恢复与倒U型耐肥收益曲线。
- [x] **生长控制**: 基于肥力与基因的主动式作物生长干预（Active Growth）。
- [x] **交互工具**: 农夫单片镜 (视觉反馈)、肥料 (有机/化肥)。
- [x] **基因基础**: 种子分析仪、未鉴定/已鉴定种子区分、NBT存储。
- [x] **杂交流程**: 手工花粉采集、人工授粉、收割时子代基因计算与遗传。

### 待实现 (Pending)
*(基于 `TECH_DESIGN_DOC.md` 的差距分析)*
- [ ] **视觉层**: 耕地材质随肥力动态变化 (ItemsAdder/Oraxen)。
- [ ] **自动化杂交**: 
    - 文档设计了 **授粉架 (Pollination Rack)** 以连接两块耕地实现自动杂交。
    - 目前仅实现了手工授粉，需评估是否仍需开发授粉架以支持自动化农业。
- [ ] **种子提纯 (Purification)**:
    - 文档提及“在优秀环境下种植积累生长势以产出高星种子”。
    - 目前仅能通过杂交突变提升数值，缺乏单一种植提升路径。
- [ ] **温室系统**: 
    - 需实现玻璃判定与微气候温度计算。
    - 目前基因中的 `Optimal Temp` 尚未实际接入环境温度判定。
- [ ] **烹饪系统**: 
    - 厨具交互 (切菜板/铁锅) 与 QTE 烹饪小游戏。
    - 双维度 (Tier/Quality) 评价体系。


---

**文档维护人**: 开发组
**最后更新**: 2025-12-22
